---
title: "Modeling_R_final"
author: "Huiyi Zhu"
date: "2025-12-06"
output: git_document
---

## Prepare
```{r}
library(tidyverse)
library(ggplot2)
library(patchwork)
library(broom)
parkevent = read.csv("parkevent_clean.csv")
```


## Modeling Workflow Diagram

                         ┌──────────────────────────────────┐
                         │  Exploratory Data Analysis (EDA) │
                         │  - Histogram of attendance       │
                         │  - mean–variance check           │
                         │  → Identify skewness & overdispersion
                         └──────────────────────────────────┘
                                         │
                                         ▼
                   ┌───────────────────────────────────────────────┐
                   │ Univariate Analysis                           │
                   │ - Kruskal–Wallis tests for each predictor     │
                   │ - Compute η² effect sizes                     │
                   │ → Assess which predictors show meaningful     │
                   │   variation in attendance                     │
                   └───────────────────────────────────────────────┘
                                         │
                                         ▼
             ┌──────────────────────────────────────────────────────────┐
             │ Model Building: Cross-Validated Variable Selection       │
             │ - Define Simple, Medium, Full predictor sets             │
             │ - Monte Carlo CV with RMSE as performance metric         │
             │ → Select predictor set with best out-of-sample RMSE      │
             └──────────────────────────────────────────────────────────┘
                                         │
                                         ▼
             ┌──────────────────────────────────────────────────────────┐
             │ Final Model Fitting                                      │
             │ - Fit Negative Binomial regression using selected vars   │
             │ - Extract IRRs and confidence intervals                  │
             │ → Interpret effect sizes and direction of associations   │
             └──────────────────────────────────────────────────────────┘
                                         │
                                         ▼
                   ┌───────────────────────────────────────────────┐
                   │ Final Inference & Interpretation              │
                   │ - Discuss strongest predictors                │
                   │ - Compare event characteristics & attendance  │
                   │ - Guide practical recommendations             │
                   └───────────────────────────────────────────────┘


### Exploratory distribution plots
Before conducting formal statistical analyses, we examined the distribution of the outcome variable, attendance, to assess its shape and variability. Understanding the distribution is essential for determining whether parametric assumptions are met and for selecting an appropriate modeling framework.
```{r}
 a <- ggplot(parkevent, aes(x = attendance)) +
  geom_histogram(bins = 40, fill = "steelblue", color = "white") +
  labs(title = "Attendance Distribution (Count)",
       x = "Attendance", y = "Count") +
  theme_minimal()

b <- ggplot(parkevent, aes(x = attendance)) +
  geom_histogram(bins = 40, fill = "tomato", color = "white") +
  scale_x_log10() +
  labs(title = "Attendance Distribution (Log Scale)",
       x = "Attendance (log10 scale)", y = "Count") +
  theme_minimal()

a+b
```

```{r}
mean_var <- parkevent %>%
  summarise(mean_att = mean(attendance), var_att = var(attendance))

mean_var

```
Exploratory plots revealed that attendance is highly right-skewed with a long tail, and the variance greatly exceeds the mean, indicating overdispersion. These characteristics justify the use of non-parametric tests in the univariate stage and a Negative Binomial model for the final multivariable analysis.


### Univariate Analysis
We first examined whether attendance differed across levels of each categorical predictor (season, time of day, borough, event type, location type, and audience-related indicators) using the Kruskal–Wallis test, a non-parametric method appropriate for skewed count outcomes. For each variable, we also computed an η² effect size to quantify the magnitude of group differences. These results provide an initial assessment of which predictors meaningfully explain variation in attendance and should be considered in subsequent multivariable modeling.

```{r}
library(MASS)
library(modelr)
```


```{r}
predictors <- c("season", "time_period", "borough",
                "event_type", "location_type",
                "kids_friendly", "senior_friendly", "adults_only")

#Function to compute eta-squared for KW
eta_kw <- function(x, g){
  kw <- kruskal.test(x ~ g)
  H  <- kw$statistic
  k  <- length(unique(g))
  n  <- length(x)
  eta2 <- as.numeric((H - k + 1) / (n - k))
  return(eta2)
}

# Run Kruskal–Wallis tests for all predictors
kw_results <- map_df(predictors, ~ {
  form <- as.formula(paste("attendance ~", .x))
  
  kt  <- broom::tidy(kruskal.test(form, data = parkevent))
  eta2 <- eta_kw(parkevent$attendance, parkevent[[.x]])
  
  kt |> 
    mutate(variable = .x,
           eta2 = eta2)
})

# Classify effect sizes ----
kw_results <- kw_results |> 
  mutate(effect_strength = case_when(
    eta2 >= 0.14 ~ "large",
    eta2 >= 0.06 ~ "medium",
    eta2 >= 0.01 ~ "small",
    TRUE ~ "very small"
  ))

kw_results |>
  dplyr::select (variable, p.value, effect_strength)

```
Across all predictors, the Kruskal–Wallis tests indicated statistically significant differences in attendance (p < 0.05), with effect sizes ranging from very small to medium. Variables with medium η² values (event type and location type) show stronger associations with attendance and were prioritized for inclusion in the multivariable model.

To evaluate their combined predictive value and adjust for potential confounding, we proceeded to build multivariable models.

### Multivariable Model: Negative Binomial Regression
To identify the predictors that best explain variation in attendance, we compared several candidate models using cross-validated RMSE, an unbiased measure of out-of-sample predictive performance. We used log-linear models for this stage because they are computationally stable and well-suited for repeated Monte Carlo cross-validation. Based on the RMSE comparison, we selected the most predictive set of variables and then refit the final model using Negative Binomial regression, which is appropriate for inference with overdispersed count outcomes such as attendance.

```{r}
#Define candidate models
form_simple <- log(attendance + 1) ~ event_type + location_type

form_medium <- log(attendance + 1) ~ season + time_period + borough +
  event_type + location_type

form_full <- log(attendance + 1) ~ season + time_period + borough +
  event_type + location_type + kids_friendly + senior_friendly + adults_only

#cross-validated RMSE
cv_rmse <- function(formula, data, n_splits = 50, test_prop = 0.1) {
  set.seed(123)
  
cv <- crossv_mc(data, n_splits, test = test_prop)
  
cv <- cv %>%
    mutate(
      model = map(train, ~ lm(formula, data = .x)),
      rmse  = map2_dbl(model, test, ~ rmse(.x, .y))
    )
  
mean(cv$rmse)
}

rmse_simple <- cv_rmse(form_simple, parkevent, n_splits = 50, test_prop = 0.1)
rmse_medium <- cv_rmse(form_medium, parkevent, n_splits = 50, test_prop = 0.1)
rmse_full   <- cv_rmse(form_full,   parkevent, n_splits = 50, test_prop = 0.1)

cv_results <- tibble(
  model     = c("Simple", "Medium", "Full"),
  mean_RMSE = c(rmse_simple, rmse_medium, rmse_full)
)

cv_results
```
Cross-validated RMSE values were similar across the three candidate models, with the Full model achieving the lowest prediction error (RMSE = 1.4263). Although the difference is modest, the Full model provided the best out-of-sample predictive performance and was therefore selected for the final analysis.

Using the selected predictor set, we fit our final model with a Negative Binomial regression:

```{r}
model_nb <- glm.nb(
  attendance ~ season + time_period + borough +
    event_type + location_type + kids_friendly + senior_friendly + adults_only,
  data = parkevent
)

summary(model_nb)

irr_table <- tidy(model_nb, conf.int = TRUE, exponentiate = TRUE)
irr_table

```
In this model, attendance is modeled as a function of season, time of day, borough, event type, location type, and audience indicators. We exponentiate the coefficients to obtain incidence rate ratios (IRRs) and 95% confidence intervals, which quantify the multiplicative change in expected attendance associated with each predictor while holding the others constant.

The Negative Binomial model shows that several event characteristics are strongly associated with attendance. 
Compared with spring events, winter events have significantly lower expected attendance (IRR = 0.73, 95% CI: 0.54–1.00), while summer and fall do not differ significantly from spring. 

Afternoon and night events attract more participants than morning events (Afternoon: IRR = 1.35, 95% CI: 1.12–1.61; Night: IRR = 1.25, 95% CI: 1.03–1.51). Relative to Bronx, events in Manhattan, Queens, and Staten Island show higher attendance (IRRs ≈ 1.28–1.68), with Manhattan having the largest effect. 

Community-based events have higher attendance than Agency Produced events (IRR = 1.31, 95% CI: 1.14–1.50), and events held in schools and parks are particularly well-attended (School: IRR = 4.17, 95% CI: 1.43–9.64; Park: IRR = 1.98, 95% CI: 1.00–4.38). 

For the audience, adults-only events draw substantially fewer participants than events that are open to children or seniors (IRR = 0.44, 95% CI: 0.27–0.69), while the kids-friendly and senior-friendly indicators are not individually significant after adjustment for other covariates.

