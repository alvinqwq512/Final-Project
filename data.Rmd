---
title: "data clean"
author: "Huiyi Zhu"
date: "2025-12-04"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## prepare

```{r}
library(tidyverse)
library(janitor)
library(ggplot2)
library(patchwork)
library(RColorBrewer)
library(broom)
```
outcome: attendance 
variables: season, event type, borough, location type, time of date



Miranda Chen: model (before 11:59PM Friday)
Huiyi Zhu: clean data (date:2022.5-present, morning5-12 afternoon 12-6 night 6-1 midnight?) + basic descriptive analysis 
Yiyang Jiao: report+video (9:00PM Sat)
Xiaoqian Lyu: report
Yuyue Ma: web(sat) 

```{r}
raw = read.csv("Parks_Special_Events_20251204.csv")
```


## Data Cleaning
```{r}
parkevent = read.csv("Parks_Special_Events_20251204.csv") |>
  janitor::clean_names() |>
  mutate(
    datetime = mdy_hms(date_and_time),
    date     = as_date(datetime), 
    year  = year(datetime),
    month = month(datetime, label = TRUE, abbr = TRUE),
    day = day(datetime),
    time = format(datetime, "%H:%M:%S"),
    season = case_when(
      month %in% c("Mar","Apr","May") ~ "Spring",
      month %in% c("Jun","Jul","Aug") ~ "Summer",
      month %in% c("Sep","Oct","Nov") ~ "Fall",
      month %in% c("Dec","Jan","Feb") ~ "Winter"), 
      season = factor(season,
        levels = c("Spring", "Summer", "Fall", "Winter")),
    hour = as.numeric(format(datetime, "%H")),
    time_period = case_when(
      hour < 5 ~ "Midnight",
      hour >= 5  & hour < 12 ~ "Morning",
      hour >= 12 & hour < 18 ~ "Afternoon",
      hour >= 18 & hour < 23 ~ "Night",
      hour >= 23   ~ "Midnight"),
   time_period = factor(time_period,
                     levels = c("Morning", "Afternoon", "Night", "Midnight")),
    attendance = as.numeric(attendance))|>  
  
  mutate(
    aud_list = str_split(audience, ";|,"),
    aud_list = map(aud_list, ~ str_trim(.x)),
    has_children = map_lgl(aud_list, ~ any(.x %in% c("Children", "Kids", "Tot"))),
    has_seniors  = map_lgl(aud_list, ~ any(.x %in% c("Seniors", "Senior"))),
    has_genpub   = map_lgl(aud_list, ~ any(.x == "General Public")),
    
    kids_friendly   = has_children | has_genpub,
    senior_friendly = has_seniors  | has_genpub,
    adults_only     = !kids_friendly & !senior_friendly)|> 
  
  select(
    -datetime,
    -unit,
    -group_name_partner,
    -date_and_time,
    -classification,
    -source,
    -hour,
    -event_name,
    -location,
    -audience,
    -aud_list,
    -has_children,
    -has_seniors,
    - has_genpub) |> 
  select(
    date, year, month, day, time, season,time_period, everything()) |> 
    filter(date >= as.Date("2021-06-01"),
           event_type != "",
           category != "",
           attendance != "")
```

We cleaned the dataset to prepare it for analyzing attendance as the primary outcome and key predictors including season, event_type, borough, location_type, and time_period. Date-time information was parsed into date, year, month, and day to support temporal analyses, and time_period was created to evaluate differences across times of day. We filtered observations to the NYC fully reopened period after COVID (date >= "2021-06-01") to avoid pandemic-related disruptions. Columns not relevant to the analysis were removed, and rows with empty event_type, category and attendance values were dropped. After cleaning, we have `r nrow(parkevent)` observations and `r ncol(parkevent)` variables. These steps produced a tidy dataset aligned with our study.

How we cleaned the audience type: We first standardized the audience field by splitting each entry into individual audience categories (e.g., “Children,” “Adults,” “Seniors,” “General Public”). Based on these cleaned components, we created three binary indicators to capture the accessibility of each event to key demographic groups.

An event was classified as kids-friendly if its audience included Children/Tot or was labeled as General Public. Similarly, an event was marked as senior-friendly if Seniors were listed or if the audience was General Public. Finally, we defined adults-only events as those not classified as kids-friendly, meaning no child-oriented groups were present in the audience description.

Dropped the unnecessary variables generated during the process

```{r}
parkevent %>% count(kids_friendly)
parkevent %>% count(senior_friendly)
parkevent %>% count(adults_only)
```




## Descriptive Analysis 
```{r}
parkevent |>
  summarize(
    mean_attendance = mean(attendance),
    median_attendance = median(attendance),
    sd_attendance = sd(attendance),
    min_attendance = min(attendance),
    max_attendance = max(attendance)) |>
  knitr::kable(digits = 2)
```

This table summarizes the distribution of attendance across all post-COVID events, including the mean, median, variability, and range of turnout. These descriptive statistics provide an essential baseline for understanding overall engagement levels and for comparing attendance across seasons, event types, boroughs, and time-of-day categories in subsequent analyses.

```{r}
plot_season =
  ggplot(parkevent, aes(x = season, y = attendance, fill=season)) +
  geom_violin(trim = FALSE, alpha = 0.5) +
  geom_boxplot(width=0.15) +
  coord_cartesian(ylim = c(0,250)) +
  scale_x_discrete(labels = c(
    "Spring" = "Spr",
    "Summer" = "Sum",
    "Fall"   = "Fal",
    "Winter" = "Win")) +
  labs(title = "By Season", x = "Season", y = "Attendance") +
  guides(fill = "none") +
  theme_minimal()

plot_time =
  ggplot(parkevent, aes(x = time_period, y = attendance, fill=time_period)) +
  geom_violin(trim = FALSE, alpha = 0.5) +
  geom_boxplot(width=0.15) +
  coord_cartesian(ylim = c(0,250)) +
  scale_x_discrete(labels = c(
    "Morning"   = "Morn",
    "Afternoon" = "Aft",
    "Night"     = "Ngt",
    "Midnight"  = "Mid")) +
  labs(title = "By Time of Day", x = "Time of Day", y = "Attendance") +
  guides(fill = "none") +
  theme_minimal()

plot_type =
  ggplot(parkevent, aes(x = event_type, y = attendance, fill = event_type)) +
  geom_violin(trim = FALSE, alpha = 0.5) +
  geom_boxplot(width = 0.15) +
  coord_cartesian(ylim = c(0,250)) +
  scale_x_discrete(labels = c(
    "Agency Produced Event" = "Agency",
    "Community Based Event" = "Community",
    "Local Event" = "Local",
    "Open House" = "Open",
    "Tournament/Competition" = "Competition")) +
   guides(fill = "none") +
  labs(
    title = "By Event Type",
    x = "Event Type",
    y = "Attendance") +
  theme_minimal()

plot_borough =
  ggplot(parkevent, aes(x = borough, y = attendance, fill=borough)) +
  geom_violin(trim = FALSE, alpha = 0.5) +
  geom_boxplot(width=0.15) +
  coord_cartesian(ylim = c(0,250)) +
  scale_x_discrete(labels = c(
    "Bronx"        = "BX",
    "Brooklyn"     = "BKN",
    "Manhattan"    = "MAN",
    "Queens"       = "QNS",
    "Staten Island"= "SI")) +
  labs(title = "By Borough", x = "Borough", y = "Attendance") +
  guides(fill = "none") +
  theme_minimal()

plot_location =
  ggplot(parkevent, aes(x = location_type, y = attendance, fill = location_type)) +
  geom_violin(trim = FALSE, alpha = 0.5) +
  geom_boxplot(width = 0.15) +
  coord_cartesian(ylim = c(0,250)) +
  scale_x_discrete(labels = c(
    "Nature Center" = "Nature",
    "Recreation Center" = "RecCen",
    "Playground" = "Playground",
    "Pool" = "Pool",
    "Park" = "Park",
    "Other" = "Other",
    "School" = "School")) +
  labs(
    title = "By Location Type",
    x = "Location Type",
    y = "Attendance") +
   guides(fill = "none") +
  theme_minimal()

parkevent_long <- parkevent |> 
  pivot_longer(
    cols = c(kids_friendly, senior_friendly, adults_only),
    names_to  = "audience_type",
    values_to = "flag"
  ) |> 
  filter(flag) |> 
  select(-flag) |> 
  mutate(
    audience_type = recode(
      audience_type,
      kids_friendly   = "Kids",
      senior_friendly = "Seniors",
      adults_only     = "Adults"))

plot_audience =
  ggplot(parkevent_long,
         aes(x = audience_type, y = attendance, fill = audience_type)) +
  geom_violin(trim = FALSE, alpha = 0.5) +
  geom_boxplot(width = 0.15) +
  coord_cartesian(ylim = c(0, 250)) +
  labs(
    title = "By Audience Type",
    x = "Audience Type",
    y = "Attendance") +
  guides(fill = "none") +
  theme_minimal()

patterns_plot =
  ((plot_season |plot_time| plot_borough) /
    (plot_audience|plot_type| plot_location))+
  plot_annotation(
    title = "Attendance Patterns Across NYC Parks Events",
    theme = theme())
patterns_plot

```

Figure displays violin–boxplots of attendance by season, time of day, borough, event type, aduience type and location type. These plots summarize both the distribution (violin shape) and central tendency (box plot) for each category, allowing visual comparison of how attendance varies across park events. We restricted the y-axis to 0–250 attendees because most events fall within this range, while a small number of very large events have much higher attendance. Without this limit, those extreme values compress the main body of the data and make differences between typical events difficult to see.


```{r}
ggplot(parkevent_long,
       aes(x = month, fill = audience_type)) +
  geom_bar(position = "fill") 
  labs(
    title = "Audience Composition by Borough",
    x = "Month",
    y = "Proportion",
    fill = "Audience Type"
  ) +
  theme_minimal()

```
This stacked bar chart shows how audience composition varies across months for NYC park events. Kids-friendly events consistently represent the largest share throughout the year, especially from April to October, indicating strong family engagement during warmer months. Senior-friendly events also maintain a substantial and steady presence, peaking in early spring and again in late summer. Adults-only events fluctuate more noticeably, with higher proportions in winter months such as January and December. Overall, the chart highlights seasonal shifts in audience needs: family-oriented programming dominates most of the year, while adult-focused events become relatively more common during colder months.

```{r}
plot_time_season =
  parkevent |>
  group_by(time_period, season) |>
  summarize(mean_attendance = mean(attendance)) |>
  ggplot(aes(x = time_period, 
             y = mean_attendance, 
             color = season, 
             group = season)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Mean Attendance by Time of Day Across Seasons",
    x = "Time of Day",
    y = "Mean Attendance",
    color = "Season") +
  theme_minimal()

plot_borough_season =
  parkevent |>
  group_by(borough, season) |>
  summarize(mean_attendance = mean(attendance)) |>
  ggplot(aes(x = season, 
             y = mean_attendance, 
             color = borough, 
             group = borough)) +
  geom_line() +
  geom_point() +
   scale_color_brewer(palette = "Dark2") +  
  labs(
    title = "Mean Attendance by Seasons Across Borough",
    x = "Season",
    y = "Mean Attendance",
    color = "borough") +
  theme_minimal()

Seasonal_plot =
  (plot_time_season / plot_borough_season) +
  plot_annotation(
    title = "Seasonal Attendance Patterns Across NYC Park Events")

Seasonal_plot
```

The first plot shows how mean attendance varies by time of day across seasons. Spring consistently has the highest turnout, especially in the afternoon, while Winter shows the sharpest decline at midnight. Fall attendance remains relatively stable across all times, whereas Summer gradually increases into the evening. The second plot compares mean attendance by seasons across borough. Staten Island and Queens show the highest seasonal peaks, particularly in Spring. Brooklyn and Manhattan maintain moderate attendance across seasons, while the Bronx shows the lowest and least variable averages. Together, these trends highlight clear seasonal and geographic differences in NYC park event engagement.


```{r}
plot_calendar =
  ggplot(parkevent, 
         aes(x = month(date, label = TRUE, abbr = TRUE), 
             y = attendance)) +
  geom_point(alpha = 0.2, color = "gray70") +
  stat_summary(fun = mean, geom = "line", aes(group = 1),
               color = "cornflowerblue", size = 1) +
  stat_summary(fun = mean, geom = "point",
               color = "cornflowerblue", size = 2) +
  labs(
    title = "Attendance Over the Calendar Year",
    x = "Month",
    y = "Attendance") +
  coord_cartesian(ylim = c(0, 250)) + 
  theme_minimal()
plot_calendar
```

This plot shows how park event attendance varies throughout the calendar year by combining individual event points with a smoothed monthly trend line. Grey points display the full distribution of attendance for all events, allowing visualization of variability within each month. Monthly averages are overlaid as a blue line to highlight broader seasonal patterns that daily fluctuations may obscure. The results show a dip in February, rising attendance during spring, a slight decline in midsummer, and another increase in October and December. Using monthly means helps reveal consistent seasonal trends while still preserving the underlying data distribution for context and interpretation.


## Modeling Workflow Diagram

                         ┌──────────────────────────────────┐
                         │  Exploratory Data Analysis (EDA) │
                         │  - Histogram of attendance       │
                         │  - mean–variance check           │
                         │  → Identify skewness & overdispersion
                         └──────────────────────────────────┘
                                         │
                                         ▼
                   ┌───────────────────────────────────────────────┐
                   │ Univariate Analysis                           │
                   │ - Kruskal–Wallis tests for each predictor     │
                   │ - Compute η² effect sizes                     │
                   │ → Assess which predictors show meaningful     │
                   │   variation in attendance                     │
                   └───────────────────────────────────────────────┘
                                         │
                                         ▼
             ┌──────────────────────────────────────────────────────────┐
             │ Model Building: Cross-Validated Variable Selection       │
             │ - Define Simple, Medium, Full predictor sets             │
             │ - Monte Carlo CV with RMSE as performance metric         │
             │ → Select predictor set with best out-of-sample RMSE      │
             └──────────────────────────────────────────────────────────┘
                                         │
                                         ▼
             ┌──────────────────────────────────────────────────────────┐
             │ Final Model Fitting                                      │
             │ - Fit Negative Binomial regression using selected vars   │
             │ - Extract IRRs and confidence intervals                  │
             │ → Interpret effect sizes and direction of associations   │
             └──────────────────────────────────────────────────────────┘
                                         │
                                         ▼
                   ┌───────────────────────────────────────────────┐
                   │ Final Inference & Interpretation              │
                   │ - Discuss strongest predictors                │
                   │ - Compare event characteristics & attendance  │
                   │ - Guide practical recommendations             │
                   └───────────────────────────────────────────────┘


### Exploratory distribution plots
Before conducting formal statistical analyses, we examined the distribution of the outcome variable, attendance, to assess its shape and variability. Understanding the distribution is essential for determining whether parametric assumptions are met and for selecting an appropriate modeling framework.
```{r}
 a <- ggplot(parkevent, aes(x = attendance)) +
  geom_histogram(bins = 40, fill = "steelblue", color = "white") +
  labs(title = "Attendance Distribution (Count)",
       x = "Attendance", y = "Count") +
  theme_minimal()

b <- ggplot(parkevent, aes(x = attendance)) +
  geom_histogram(bins = 40, fill = "tomato", color = "white") +
  scale_x_log10() +
  labs(title = "Attendance Distribution (Log Scale)",
       x = "Attendance (log10 scale)", y = "Count") +
  theme_minimal()

a+b
```

```{r}
mean_var <- parkevent %>%
  summarise(mean_att = mean(attendance), var_att = var(attendance))

mean_var

```
Exploratory plots revealed that attendance is highly right-skewed with a long tail, and the variance greatly exceeds the mean, indicating overdispersion. These characteristics justify the use of non-parametric tests in the univariate stage and a Negative Binomial model for the final multivariable analysis.


### Univariate Analysis
We first examined whether attendance differed across levels of each categorical predictor (season, time of day, borough, event type, location type, and audience-related indicators) using the Kruskal–Wallis test, a non-parametric method appropriate for skewed count outcomes. For each variable, we also computed an η² effect size to quantify the magnitude of group differences. These results provide an initial assessment of which predictors meaningfully explain variation in attendance and should be considered in subsequent multivariable modeling.

```{r}
library(MASS)
library(modelr)
```


```{r}
predictors <- c("season", "time_period", "borough",
                "event_type", "location_type",
                "kids_friendly", "senior_friendly", "adults_only")

#Function to compute eta-squared for KW
eta_kw <- function(x, g){
  kw <- kruskal.test(x ~ g)
  H  <- kw$statistic
  k  <- length(unique(g))
  n  <- length(x)
  eta2 <- as.numeric((H - k + 1) / (n - k))
  return(eta2)
}

# Run Kruskal–Wallis tests for all predictors
kw_results <- map_df(predictors, ~ {
  form <- as.formula(paste("attendance ~", .x))
  
  kt  <- broom::tidy(kruskal.test(form, data = parkevent))
  eta2 <- eta_kw(parkevent$attendance, parkevent[[.x]])
  
  kt |> 
    mutate(variable = .x,
           eta2 = eta2)
})

# Classify effect sizes ----
kw_results <- kw_results |> 
  mutate(effect_strength = case_when(
    eta2 >= 0.14 ~ "large",
    eta2 >= 0.06 ~ "medium",
    eta2 >= 0.01 ~ "small",
    TRUE ~ "very small"
  ))

kw_results |>
  dplyr::select (variable, p.value, effect_strength)

```
Across all predictors, the Kruskal–Wallis tests indicated statistically significant differences in attendance (p < 0.05), with effect sizes ranging from very small to medium. Variables with medium η² values (event type and location type) show stronger associations with attendance and were prioritized for inclusion in the multivariable model.

To evaluate their combined predictive value and adjust for potential confounding, we proceeded to build multivariable models.

### Multivariable Model: Negative Binomial Regression
To identify the predictors that best explain variation in attendance, we compared several candidate models using cross-validated RMSE, an unbiased measure of out-of-sample predictive performance. We used log-linear models for this stage because they are computationally stable and well-suited for repeated Monte Carlo cross-validation. Based on the RMSE comparison, we selected the most predictive set of variables and then refit the final model using Negative Binomial regression, which is appropriate for inference with overdispersed count outcomes such as attendance.

```{r}
#Define candidate models
form_simple <- log(attendance + 1) ~ event_type + location_type

form_medium <- log(attendance + 1) ~ season + time_period + borough +
  event_type + location_type

form_full <- log(attendance + 1) ~ season + time_period + borough +
  event_type + location_type + kids_friendly + senior_friendly + adults_only

#cross-validated RMSE
cv_rmse <- function(formula, data, n_splits = 50, test_prop = 0.1) {
  set.seed(123)
  
cv <- crossv_mc(data, n_splits, test = test_prop)
  
cv <- cv %>%
    mutate(
      model = map(train, ~ lm(formula, data = .x)),
      rmse  = map2_dbl(model, test, ~ rmse(.x, .y))
    )
  
mean(cv$rmse)
}

rmse_simple <- cv_rmse(form_simple, parkevent, n_splits = 50, test_prop = 0.1)
rmse_medium <- cv_rmse(form_medium, parkevent, n_splits = 50, test_prop = 0.1)
rmse_full   <- cv_rmse(form_full,   parkevent, n_splits = 50, test_prop = 0.1)

cv_results <- tibble(
  model     = c("Simple", "Medium", "Full"),
  mean_RMSE = c(rmse_simple, rmse_medium, rmse_full)
)

cv_results
```
Cross-validated RMSE values were similar across the three candidate models, with the Full model achieving the lowest prediction error (RMSE = 1.4263). Although the difference is modest, the Full model provided the best out-of-sample predictive performance and was therefore selected for the final analysis.

Using the selected predictor set, we fit our final model with a Negative Binomial regression:

```{r}
model_nb <- glm.nb(
  attendance ~ season + time_period + borough +
    event_type + location_type + kids_friendly + senior_friendly + adults_only,
  data = parkevent
)

summary(model_nb)

irr_table <- tidy(model_nb, conf.int = TRUE, exponentiate = TRUE)
irr_table

```
In this model, attendance is modeled as a function of season, time of day, borough, event type, location type, and audience indicators. We exponentiate the coefficients to obtain incidence rate ratios (IRRs) and 95% confidence intervals, which quantify the multiplicative change in expected attendance associated with each predictor while holding the others constant.

The Negative Binomial model shows that several event characteristics are strongly associated with attendance. 
Compared with spring events, winter events have significantly lower expected attendance (IRR = 0.73, 95% CI: 0.54–1.00), while summer and fall do not differ significantly from spring. 

Afternoon and night events attract more participants than morning events (Afternoon: IRR = 1.35, 95% CI: 1.12–1.61; Night: IRR = 1.25, 95% CI: 1.03–1.51). Relative to Bronx, events in Manhattan, Queens, and Staten Island show higher attendance (IRRs ≈ 1.28–1.68), with Manhattan having the largest effect. 

Community-based events have higher attendance than Agency Produced events (IRR = 1.31, 95% CI: 1.14–1.50), and events held in schools and parks are particularly well-attended (School: IRR = 4.17, 95% CI: 1.43–9.64; Park: IRR = 1.98, 95% CI: 1.00–4.38). 

For the audience, adults-only events draw substantially fewer participants than events that are open to children or seniors (IRR = 0.44, 95% CI: 0.27–0.69), while the kids-friendly and senior-friendly indicators are not individually significant after adjustment for other covariates.

A forest plot of IRRs was created to visually summarize the estimated effects and identify predictors with statistically significant associations with attendance.
```{r}

irr_table2 <- irr_table %>%
  filter(term != "(Intercept)") %>%
  mutate(
    significant = ifelse(conf.low > 1 | conf.high < 1, "Significant", "Not Significant")
  )

ggplot(irr_table2, aes(x = reorder(term, estimate), y = estimate,
                       color = significant)) +
  geom_point(size = 3) +
   geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  scale_color_manual(values = c("Significant" = "red", 
                                "Not Significant" = "steelblue")) +
  coord_flip() +
  labs(
    title = "Incidence Rate Ratios (IRRs) with 95% Confidence Intervals",
    x = "Predictor",
    y = "IRR",
    color = ""
  ) +
  theme_minimal(base_size = 13)


```

